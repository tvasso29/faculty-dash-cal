<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Staff PTO</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 12px;
    background: white;
  }
  h3 {
    margin: 8px 0 4px 0;
  }
  ul {
    padding-left: 18px;
    margin-top: 4px;
  }
  .nosub {
    color: #777;
  }
</style>
</head>

<body>

<h3>Whoâ€™s Out Today</h3>
<ul id="today">Loadingâ€¦</ul>

<h3>Whoâ€™s Out Tomorrow</h3>
<ul id="tomorrow">Loadingâ€¦</ul>

<script>
var icsUrl = "https://calendar.google.com/calendar/ical/c_c0efeb6a7b5178f23b479e66b826d463bd8b94ece71ff575678dfa1f75e7d1ed%40group.calendar.google.com/public/basic.ics";

function key(d) {
  var y = d.getFullYear();
  var m = ("0" + (d.getMonth()+1)).slice(-2);
  var day = ("0" + d.getDate()).slice(-2);
  return y + m + day;
}

var today = new Date();
var tomorrow = new Date();
tomorrow.setDate(today.getDate() + 1);

var todayKey = key(today);
var tomorrowKey = key(tomorrow);

fetch(icsUrl)
  .then(function(r){ return r.text(); })
  .then(function(text){
    var events = text.split("BEGIN:VEVENT").slice(1);
    var todayList = document.getElementById("today");
    var tomorrowList = document.getElementById("tomorrow");

    todayList.innerHTML = "";
    tomorrowList.innerHTML = "";

    var foundToday = false;
    var foundTomorrow = false;

    for (var i=0;i<events.length;i++) {
      var e = events[i];

      var summaryMatch = e.match(/SUMMARY:(.*)/);
      var startMatch = e.match(/DTSTART[^:]*:(\d{8})/);
      var endMatch = e.match(/DTEND[^:]*:(\d{8})/);

      if (!summaryMatch || !startMatch) continue;

      var title = summaryMatch[1].replace(/\\n/g,"").trim();
      var start = startMatch[1];
      var end = endMatch ? endMatch[1] : start;

      // Extract sub [Name]
      var subMatch = title.match(/\[(.*?)\]/);
      var subText = subMatch ? " â€” Sub: " + subMatch[1] : " â€” No Sub";

      var cleanTitle = title.replace(/\[.*?\]/, "").trim();

      if (todayKey >= start && todayKey < end) {
        var li = document.createElement("li");
        li.innerText = cleanTitle + subText;
        todayList.appendChild(li);
        foundToday = true;
      }

      if (tomorrowKey >= start && tomorrowKey < end) {
        var li2 = document.createElement("li");
        li2.innerText = cleanTitle + subText;
        tomorrowList.appendChild(li2);
        foundTomorrow = true;
      }
    }

    if (!foundToday) {
      todayList.innerHTML = "<li>No one is out today ðŸŽ‰</li>";
    }

    if (!foundTomorrow) {
      tomorrowList.innerHTML = "<li>No one is out tomorrow</li>";
    }
  })
  .catch(function(){
    document.getElementById("today").innerHTML = "<li>Unable to load calendar</li>";
    document.getElementById("tomorrow").innerHTML = "<li>Unable to load calendar</li>";
  });
</script>

</body>
</html>
